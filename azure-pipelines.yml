name: 1.0.$(Date:yyyyMMdd)$(Rev:.rr)

trigger:
  branches:
    include:
      - dev

pr:
  branches:
    include:
      - dev

variables:
  - group: var-group-finaipro-azf-dev

pool: Azure Pipelines

stages:
- stage: Build
  displayName: 'Build Stage'
  jobs:
  - job: Build
    displayName: 'Build Job'
    steps:
    - script: |
        echo "Building the project..."
        mkdir -p $(Build.ArtifactStagingDirectory)
        cp -R * $(Build.ArtifactStagingDirectory)/
      displayName: 'Run build script'

    - script: |
        echo "Copying environment variables..."
        chmod +x copy_env_variables.sh
        ./copy_env_variables.sh
      displayName: 'Copiar variables de entorno'

    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)'
        artifact: 'AZF Artifact'
        publishLocation: 'Pipeline'

- stage: Deploy
  dependsOn:
    - Build
  displayName: 'Deploy Stage'
  jobs:
  - job: DeployAzureFunctions
    displayName: 'Deploy Azure Functions'
    steps:
    - task: DownloadPipelineArtifact@2
      inputs:
        artifactName: 'AZF Artifact'
        downloadPath: '$(Pipeline.Workspace)/AZF Artifact'

    - script: |
        echo "APPINSIGHTS_INSTRUMENTATIONKEY=$(APPINSIGHTS_INSTRUMENTATIONKEY)"
        echo "AzureWebJobsFeatureFlags=$(AzureWebJobsFeatureFlags)"
        echo "DATALAKE_ACCESS_KEY=$(DATALAKE_ACCESS_KEY)"
        echo "DATALAKE_ACCOUNT_NAME=$(DATALAKE_ACCOUNT_NAME)"
        echo "DATALAKE_CONTAINER_NAME=$(DATALAKE_CONTAINER_NAME)"
        echo "DATALAKE_TARGET_BASE_FOLDER=$(DATALAKE_TARGET_BASE_FOLDER)"
        echo "DATALAKE_TARGET_CONTAINER_NAME=$(DATALAKE_TARGET_CONTAINER_NAME)"
        echo "KEYVAULT_URL=$(KEYVAULT_URL)"
        echo "TRADING_ECONOMICS_INDICATORS=$(TRADING_ECONOMICS_INDICATORS)"
      displayName: 'Echo environment variables'

    - task: AzureFunctionApp@1
      inputs:
        azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
        appType: 'functionApp'
        appName: '$(AZF_NAME)'
        package: '$(Pipeline.Workspace)/AZF Artifact'
        runtimeStack: 'DOTNET|6.0'
        appSettings: |
            { "name": "APPINSIGHTS_INSTRUMENTATIONKEY", "value": "$(APPINSIGHTS_INSTRUMENTATIONKEY)", "slotSetting": false },
            { "name": "AzureWebJobsFeatureFlags", "value": "$(AzureWebJobsFeatureFlags)", "slotSetting": false },
            { "name": "DATALAKE_ACCESS_KEY", "value": "$(DATALAKE_ACCESS_KEY)", "slotSetting": false },
            { "name": "DATALAKE_ACCOUNT_NAME", "value": "$(DATALAKE_ACCOUNT_NAME)", "slotSetting": false },
            { "name": "DATALAKE_CONTAINER_NAME", "value": "$(DATALAKE_CONTAINER_NAME)", "slotSetting": false },
            { "name": "DATALAKE_TARGET_BASE_FOLDER", "value": "$(DATALAKE_TARGET_BASE_FOLDER)", "slotSetting": false },
            { "name": "DATALAKE_TARGET_CONTAINER_NAME", "value": "$(DATALAKE_TARGET_CONTAINER_NAME)", "slotSetting": false },
            { "name": "KEYVAULT_URL", "value": "$(KEYVAULT_URL)", "slotSetting": false },
            { "name": "TRADING_ECONOMICS_INDICATORS", "value": "[\"CO1:COM\", \"SCO:COM\", \"XAGUSD:CUR\", \"XPTUSD:CUR\", \"HG1:COM\", \"XAUUSD:CUR\", \"SPSCFI:COM\", \"USGG2YR:IND\", \"USGG10YR:IND\"]", "slotSetting": false }
          
