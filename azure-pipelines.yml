name: 1.0.$(Date:yyyyMMdd)$(Rev:.rr)

trigger:
  branches:
    include:
      - dev

pr:
  branches:
    include:
      - dev

variables:
  - group: var-group-finaipro-azf-dev

pool: Azure Pipelines

stages:
- stage: Build
  displayName: 'Build Stage'
  jobs:
  - job: Build
    displayName: 'Build Job'
    steps:
    - script: |
        echo "Building the project..."
        mkdir -p $(Build.ArtifactStagingDirectory)
        cp -R * $(Build.ArtifactStagingDirectory)/
      displayName: 'Run build script'

    - script: |
        echo "Copying environment variables..."
        chmod +x copy_env_variables.sh
        ./copy_env_variables.sh
      displayName: 'Copiar variables de entorno'
      env:
        APPINSIGHTS_INSTRUMENTATIONKEY: 'f86f341d-c6d1-455a-86c6-198fe547d0d1'
        AzureWebJobsFeatureFlags: 'IEnableWorkerIndexing'
        DATALAKE_ACCESS_KEY: 's0W/Nt4VmatnSHSexmROUAdjTRlXBhBqRoITc0m7agtXUaBodm96lbIJ0S1IcZeS52hj4gZ7WoGP+ASt90XA/Q=='
        DATALAKE_ACCOUNT_NAME: 'stdlfinaiprodeveu02m'
        DATALAKE_CONTAINER_NAME: 'trading-economics-persistent-data'
        DATALAKE_TARGET_BASE_FOLDER: 'trading_economics'
        DATALAKE_TARGET_CONTAINER_NAME: 'raw'
        KEYVAULT_URL: 'https://kv-finaipro-dev-eu02-m.vault.azure.net/'
        TRADING_ECONOMICS_INDICATORS: '["CO1:COM", "SCO:COM", "XAGUSD:CUR", "XPTUSD:CUR", "HG1:COM", "XAUUSD:CUR", "SPSCFI:COM", "USGG2YR:IND", "USGG10YR:IND"]'
       


    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)'
        artifact: 'AZF Artifact'
        publishLocation: 'Pipeline'

- stage: Deploy
  dependsOn:
    - Build
  displayName: 'Deploy Stage'
  jobs:
  - job: DeployAzureFunctions
    displayName: 'Deploy Azure Functions'
    steps:
    - task: DownloadPipelineArtifact@2
      inputs:
        artifactName: 'AZF Artifact'
        downloadPath: '$(Pipeline.Workspace)/AZF Artifact'
    
    - task: AzureFunctionApp@1
      inputs:
        azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
        appType: 'functionApp'
        appName: '$(AZF_NAME)'
        package: '$(Pipeline.Workspace)/AZF Artifact'
